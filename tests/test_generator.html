<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generator.js Unit Tests</title>
    <style>
        body { font-family: sans-serif; }
        .test-case { margin-bottom: 1em; }
        .pass { color: green; }
        .fail { color: red; }
    </style>
</head>
<body>
    <h1>Unit Tests for generator.js</h1>
    <div id="test-results"></div>

    <script src="../static/js/generator.js"></script>

    <script>
        const resultsContainer = document.getElementById('test-results');
        let gameData = {};

        function test(description, testFn) {
            const resultDiv = document.createElement('div');
            resultDiv.classList.add('test-case');
            try {
                testFn();
                resultDiv.innerHTML = `<span class="pass">PASS</span>: ${description}`;
            } catch (e) {
                resultDiv.innerHTML = `<span class="fail">FAIL</span>: ${description}<br><pre>${e.stack}</pre>`;
            }
            resultsContainer.appendChild(resultDiv);
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || "Assertion failed");
            }
        }

        async function runTests() {
            try {
                gameData = await getGameData();
            } catch (e) {
                resultsContainer.innerHTML = `<div class="fail">FATAL: Could not load game data. ${e.message}</div>`;
                return;
            }

            test("Mossling should get a valid Knack from the simplified list", () => {
                const mockAdventurer = { kindred: "Mossling", level: 1, class: "Fighter" };
                const spells = assignSpells(mockAdventurer, gameData);
                assert(spells.knack, "Result should have a 'knack' property");
                assert(gameData.spells_refactored.knacks.includes(spells.knack), `Generated knack '${spells.knack}' is not in the data array.`);
            });

            test("Level 1 Elf Enchanter gets 1 Kindred Glamour + 1 Class Glamour", () => {
                const mockAdventurer = { kindred: "Elf", level: 1, class: "Enchanter" };
                const spells = assignSpells(mockAdventurer, gameData);
                assert(spells.glamours && spells.glamours.length === 2, `Expected 2 glamours, but got ${spells.glamours ? spells.glamours.length : 0}`);
            });

            test("Enchanter level modifier function should return correct values", () => {
                assert(getEnchanterLevelModifier(1) === 0, "Level 1-2 should have +0 modifier");
                assert(getEnchanterLevelModifier(2) === 0, "Level 1-2 should have +0 modifier");
                assert(getEnchanterLevelModifier(3) === 1, "Level 3-5 should have +1 modifier");
                assert(getEnchanterLevelModifier(5) === 1, "Level 3-5 should have +1 modifier");
                assert(getEnchanterLevelModifier(6) === 2, "Level 6-9 should have +2 modifier");
                assert(getEnchanterLevelModifier(9) === 2, "Level 6-9 should have +2 modifier");
                assert(getEnchanterLevelModifier(10) === 3, "Level 10+ should have +3 modifier");
            });

            test("Enchanter rune roll logic should map to correct rune types", () => {
                const originalRoll = window.roll;
                const originalGetRandomItem = window.getRandomItem;

                // Mock getRandomItem to return a predictable value
                window.getRandomItem = (arr) => arr[0];

                // Test Lesser Rune boundary
                window.roll = () => 2; // 2 + mod(0) at Lvl 1 = 2 -> no rune
                let spells = assignSpells({ kindred: "Human", class: "Enchanter", level: 1 }, gameData);
                assert(!spells.runes, "Roll of 2 at Lvl 1 should result in no rune");

                window.roll = () => 3; // 3 + mod(0) at Lvl 1 = 3 -> lesser
                spells = assignSpells({ kindred: "Human", class: "Enchanter", level: 1 }, gameData);
                assert(spells.runes && Object.keys(spells.runes.lesser).length === 1, "Roll of 3 at Lvl 1 should grant a lesser rune");

                // Test Greater Rune boundary
                window.roll = () => 7;
                spells = assignSpells({ kindred: "Human", class: "Enchanter", level: 3 }, gameData);
                // Lvl 1: roll 7, mod 0 -> 7 -> lesser
                // Lvl 2: roll 7, mod 0 -> 7 -> lesser
                // Lvl 3: roll 7, mod 1 -> 8 -> greater
                assert(spells.runes && Object.keys(spells.runes.lesser).length === 1 && spells.runes.lesser[gameData.spells_refactored.runes.lesser[0]] === 2, "Roll of 7 up to Lvl 3 should grant 2 lesser runes");
                assert(spells.runes && Object.keys(spells.runes.greater).length === 1, "Roll of 7 up to Lvl 3 should grant 1 greater rune");

                // Test Mighty Rune boundary
                window.roll = () => 10;
                spells = assignSpells({ kindred: "Human", class: "Enchanter", level: 6 }, gameData);
                // Lvl 1-2: roll 10, mod 0 -> 10 -> greater
                // Lvl 3-5: roll 10, mod 1 -> 11 -> greater
                // Lvl 6: roll 10, mod 2 -> 12 -> mighty
                assert(spells.runes && Object.keys(spells.runes.greater).length === 1 && spells.runes.greater[gameData.spells_refactored.runes.greater[0]] === 5, "Roll of 10 up to Lvl 6 should grant 5 greater runes");
                assert(spells.runes && Object.keys(spells.runes.mighty).length === 1, "Roll of 10 up to Lvl 6 should grant 1 mighty rune");

                // Restore original functions
                window.roll = originalRoll;
                window.getRandomItem = originalGetRandomItem;
            });

            test("Rune frequency calculation should be correct", () => {
                // Lesser runes
                assert(getRuneFrequency('lesser', 1, 1) === 'Once per day', "Lesser rune at Lvl 1");
                assert(getRuneFrequency('lesser', 5, 1) === 'Twice per day', "Lesser rune at Lvl 5");
                assert(getRuneFrequency('lesser', 10, 1) === 'Thrice per day', "Lesser rune at Lvl 10");
                assert(getRuneFrequency('lesser', 1, 2) === 'Twice per day', "Duplicate lesser rune at Lvl 1");
                assert(getRuneFrequency('lesser', 5, 3) === '8 times per day', "Triple lesser rune at Lvl 5");

                // Greater runes
                assert(getRuneFrequency('greater', 1, 1) === 'Once per Level', "Greater rune at Lvl 1");
                assert(getRuneFrequency('greater', 7, 1) === 'Once per week', "Greater rune at Lvl 7");
                assert(getRuneFrequency('greater', 10, 1) === 'Once per day', "Greater rune at Lvl 10");
                assert(getRuneFrequency('greater', 1, 2) === 'Twice per Level', "Duplicate greater rune at Lvl 1");

                // Mighty runes
                assert(getRuneFrequency('mighty', 9, 1) === 'Once ever', "Mighty rune at Lvl 9");
                assert(getRuneFrequency('mighty', 10, 1) === 'Once per year', "Mighty rune at Lvl 10");
                assert(getRuneFrequency('mighty', 9, 2) === 'Twice ever', "Duplicate mighty rune at Lvl 9");
            });

            test("Friar gets the correct number of Holy Spells by level", () => {
                 const mockLvl1Friar = { kindred: "Human", level: 1, class: "Friar" };
                 const spellsLvl1 = assignSpells(mockLvl1Friar, gameData);
                 assert(spellsLvl1.holy.rank1.length === 1, "Lvl 1 Friar should have 1 rank1 spell");

                 const mockLvl5Friar = { kindred: "Human", level: 5, class: "Friar" };
                 const spellsLvl5 = assignSpells(mockLvl5Friar, gameData);
                 assert(spellsLvl5.holy.rank1.length === 3, "Lvl 5 Friar should have 3 rank1 spells");
                 assert(spellsLvl5.holy.rank2.length === 2, "Lvl 5 Friar should have 2 rank2 spells");
            });
        }

        window.onload = runTests;
    </script>
</body>
</html>
